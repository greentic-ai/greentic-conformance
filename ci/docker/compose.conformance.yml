version: "3.9"

services:
  mongodb:
    image: mongo:6
    restart: unless-stopped
    volumes:
      - conformance_mongo:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand({ ping: 1 })"]
      interval: 10s
      timeout: 5s
      retries: 10

  server:
    build:
      context: ${CS_DIR:-.cache/conformance-suite}/server-dev
      dockerfile: Dockerfile
    volumes:
      - ${CS_DIR:-.cache/conformance-suite}/target/:/server/
    command: >
      java -jar /server/fapi-test-suite.jar
      -Djdk.tls.maxHandshakeMessageSize=65536
      --fintechlabs.base_url=https://localhost:8443
      --fintechlabs.devmode=true
      --fintechlabs.makeDummyUserAdminInDevMode=false
      --fintechlabs.startredir=true
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped

  httpd:
    build:
      context: ${CS_DIR:-.cache/conformance-suite}/httpd
      dockerfile: Dockerfile-static
    ports:
      - "8443:8443"
      - "8444:8444"
    volumes:
      - ${CS_DIR:-.cache/conformance-suite}/src/main/resources/:/usr/local/apache2/htdocs/
    depends_on:
      - server
    restart: unless-stopped

volumes:
  conformance_mongo:
