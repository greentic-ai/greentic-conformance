name: OIDF Conformance (RP)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  oidf:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      CS_URL: ${{ secrets.OIDF_CS_URL }}
      CS_TOKEN: ${{ secrets.OIDF_CS_TOKEN }}
      RP_METADATA_URL: ${{ secrets.RP_METADATA_URL }}
      CONFORMANCE_PLAN: oidcc-client-basic-certification-test-plan
      ALIAS: greentic-rp
      CLIENT_REG: dynamic_client
      REQUEST_TYPE: plain_http_request
      CONFIG_JSON: ci/plans/examples/rp-code-pkce-basic.config.json
      SUITE_BASE: ${{ secrets.OIDF_CS_URL }}
      SUITE_API_KEY: ${{ secrets.OIDF_CS_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Auto-run OIDF plan
        run: make conformance.full
